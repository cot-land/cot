// WasmGC End-to-End Tests
// Tests struct creation, field access, methods, and function parameters
// under the wasm32-gc target (GC-managed struct heap objects).
//
// Run: cot test --target=wasm32-gc test/e2e/wasmgc.cot

struct Point {
    x: i64,
    y: i64
}

struct Rect {
    x: i64,
    y: i64,
    w: i64,
    h: i64
}

struct Counter {
    value: i64
}

impl Counter {
    fn increment(self: *Counter) {
        self.value = self.value + 1
    }

    fn get(self: *Counter) i64 {
        return self.value
    }

    fn add(self: *Counter, n: i64) {
        self.value = self.value + n
    }

    fn reset(self: *Counter) {
        self.value = 0
    }
}

fn add(a: i64, b: i64) i64 {
    return a + b
}

fn point_sum(p: Point) i64 {
    return p.x + p.y
}

fn rect_area(r: Rect) i64 {
    return r.w * r.h
}

// ============================================================================
// Basic struct creation and field access
// ============================================================================

test "basic struct create" {
    var pt = Point { .x = 5, .y = 10 }
    @assertEq(pt.x, 5)
    @assertEq(pt.y, 10)
}

test "struct field arithmetic" {
    var pt = Point { .x = 3, .y = 7 }
    @assertEq(pt.x + pt.y, 10)
    @assertEq(pt.x * pt.y, 21)
}

test "four-field struct" {
    var r = Rect { .x = 1, .y = 2, .w = 10, .h = 20 }
    @assertEq(r.x, 1)
    @assertEq(r.y, 2)
    @assertEq(r.w, 10)
    @assertEq(r.h, 20)
    @assertEq(r.w * r.h, 200)
}

test "multiple struct instances" {
    var a = Point { .x = 1, .y = 2 }
    var b = Point { .x = 3, .y = 4 }
    @assertEq(a.x + b.x, 4)
    @assertEq(a.y + b.y, 6)
}

// ============================================================================
// Struct as function parameter
// ============================================================================

test "struct param" {
    var pt = Point { .x = 20, .y = 22 }
    @assertEq(point_sum(pt), 42)
}

test "struct fields as args" {
    var pt = Point { .x = 100, .y = 200 }
    @assertEq(add(pt.x, pt.y), 300)
}

test "four-field struct param" {
    var r = Rect { .x = 0, .y = 0, .w = 15, .h = 20 }
    @assertEq(rect_area(r), 300)
}

// ============================================================================
// Struct methods (self: *Type)
// ============================================================================

test "method call" {
    var c = Counter { .value = 0 }
    c.increment()
    c.increment()
    c.increment()
    @assertEq(c.get(), 3)
}

test "method with param" {
    var c = Counter { .value = 10 }
    c.add(5)
    @assertEq(c.get(), 15)
    c.add(25)
    @assertEq(c.get(), 40)
}

test "method reset" {
    var c = Counter { .value = 42 }
    @assertEq(c.get(), 42)
    c.reset()
    @assertEq(c.get(), 0)
}

// ============================================================================
// Field mutation
// ============================================================================

test "field assignment" {
    var pt = Point { .x = 1, .y = 2 }
    pt.x = 10
    pt.y = 20
    @assertEq(pt.x, 10)
    @assertEq(pt.y, 20)
}

// ============================================================================
// Mixed struct types
// ============================================================================

test "mixed struct types" {
    var pt = Point { .x = 5, .y = 10 }
    var r = Rect { .x = 1, .y = 2, .w = 3, .h = 4 }
    @assertEq(pt.x + r.w, 8)
    @assertEq(pt.y + r.h, 14)
}
