import "std/url"

test "parse simple http url" {
    var u = parseUrl("http://example.com/path")
    @assertEq(urlScheme(u), "http")
    @assertEq(urlHost(u), "example.com")
    @assertEq(urlPath(u), "/path")
    @assertEq(urlPort(u), "")
    @assertEq(urlQuery(u), "")
    @assertEq(urlFragment(u), "")
}

test "parse https with port" {
    var u = parseUrl("https://localhost:8080/api")
    @assertEq(urlScheme(u), "https")
    @assertEq(urlHost(u), "localhost")
    @assertEq(urlPort(u), "8080")
    @assertEq(urlPath(u), "/api")
}

test "parse with query" {
    var u = parseUrl("http://example.com/search?q=hello&lang=en")
    @assertEq(urlScheme(u), "http")
    @assertEq(urlHost(u), "example.com")
    @assertEq(urlPath(u), "/search")
    @assertEq(urlQuery(u), "q=hello&lang=en")
}

test "parse with fragment" {
    var u = parseUrl("http://example.com/page#section")
    @assertEq(urlPath(u), "/page")
    @assertEq(urlFragment(u), "section")
}

test "parse with query and fragment" {
    var u = parseUrl("http://example.com/page?key=val#top")
    @assertEq(urlPath(u), "/page")
    @assertEq(urlQuery(u), "key=val")
    @assertEq(urlFragment(u), "top")
}

test "parse no path" {
    var u = parseUrl("http://example.com")
    @assertEq(urlScheme(u), "http")
    @assertEq(urlHost(u), "example.com")
    @assertEq(urlPath(u), "/")
}

test "parse path only" {
    var u = parseUrl("/path/to/resource")
    @assertEq(urlScheme(u), "")
    @assertEq(urlHost(u), "")
    @assertEq(urlPath(u), "/path/to/resource")
}

test "parse empty" {
    var u = parseUrl("")
    @assertEq(urlScheme(u), "")
    @assertEq(urlHost(u), "")
    @assertEq(urlPath(u), "")
}

test "parse deep path" {
    var u = parseUrl("https://api.example.com/v1/users/123/posts")
    @assertEq(urlScheme(u), "https")
    @assertEq(urlHost(u), "api.example.com")
    @assertEq(urlPath(u), "/v1/users/123/posts")
}

test "urlToString roundtrip" {
    var original = "http://example.com:8080/path?q=1#top"
    var u = parseUrl(original)
    var result = urlToString(u)
    @assertEq(result, original)
}

test "urlToString no port" {
    var u = parseUrl("https://example.com/path")
    @assertEq(urlToString(u), "https://example.com/path")
}

test "urlToString with query only" {
    var u = parseUrl("http://example.com/?q=test")
    @assertEq(urlQuery(u), "q=test")
}

test "parse ftp scheme" {
    var u = parseUrl("ftp://files.example.com/pub/data.txt")
    @assertEq(urlScheme(u), "ftp")
    @assertEq(urlHost(u), "files.example.com")
    @assertEq(urlPath(u), "/pub/data.txt")
}
