// Auto scope-exit cleanup tests.
// Structs with free() methods get automatic cleanup at scope exit.

import "std/list"
import "std/map"

test "auto_free_list" {
    var nums: List(i64) = .{}
    nums.append(10)
    nums.append(20)
    @assert_eq(nums.len(), 2)
    // nums.free() called automatically at scope exit
}

test "auto_free_map" {
    var m: Map(i64, i64) = .{}
    m.set(1, 100)
    m.set(2, 200)
    @assert_eq(m.get(1), 100)
    @assert_eq(m.len(), 2)
    // m.free() called automatically
}

test "auto_free_multiple" {
    var a: List(i64) = .{}
    var b: List(i64) = .{}
    a.append(1)
    b.append(2)
    @assert_eq(a.get(0), 1)
    @assert_eq(b.get(0), 2)
    // b.free() then a.free() (LIFO order)
}

test "explicit_free_still_works" {
    var m: Map(i64, i64) = .{}
    m.set(1, 100)
    m.free()
    // scope exit calls free() again â€” Map.free() is idempotent (checks capacity > 0)
    @assert_eq(m.len(), 0)
}

test "return_transfers_ownership" {
    // The returned value should NOT be auto-freed
    // (tested by using the value after the call)
    var m: Map(i64, i64) = .{}
    m.set(1, 42)
    @assert_eq(m.get(1), 42)
    m.free()
}
