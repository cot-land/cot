import "std/dotenv"

test "parse simple" {
    var env = parseEnv("KEY=value")
    @assertEq(entryCount(env), 1)
    @assertEq(entryKey(env, 0), "KEY")
    @assertEq(entryValue(env, 0), "value")
}

test "parse multiple" {
    var env = parseEnv("A=1\nB=2\nC=3")
    @assertEq(entryCount(env), 3)
    @assertEq(entryKey(env, 0), "A")
    @assertEq(entryValue(env, 0), "1")
    @assertEq(entryKey(env, 2), "C")
    @assertEq(entryValue(env, 2), "3")
}

test "skip comments" {
    var env = parseEnv("# comment\nKEY=val")
    @assertEq(entryCount(env), 1)
    @assertEq(entryKey(env, 0), "KEY")
}

test "skip empty lines" {
    var env = parseEnv("\n\nKEY=val\n\n")
    @assertEq(entryCount(env), 1)
}

test "double quoted value" {
    var env = parseEnv("KEY=\"hello world\"")
    @assertEq(entryValue(env, 0), "hello world")
}

test "single quoted value" {
    var env = parseEnv("KEY='hello'")
    @assertEq(entryValue(env, 0), "hello")
}

test "inline comment" {
    var env = parseEnv("KEY=value # this is a comment")
    @assertEq(entryValue(env, 0), "value")
}

test "whitespace trimming" {
    var env = parseEnv("  KEY  =  value  ")
    @assertEq(entryKey(env, 0), "KEY")
    @assertEq(entryValue(env, 0), "value")
}

test "get by key" {
    var env = parseEnv("DB_HOST=localhost\nDB_PORT=5432")
    @assertEq(get(env, "DB_HOST"), "localhost")
    @assertEq(get(env, "DB_PORT"), "5432")
}

test "get missing key" {
    var env = parseEnv("KEY=val")
    @assertEq(get(env, "MISSING"), "")
}

test "has key" {
    var env = parseEnv("KEY=val")
    @assert(has(env, "KEY"))
    @assert(!has(env, "OTHER"))
}

test "empty value" {
    var env = parseEnv("KEY=")
    @assertEq(entryCount(env), 1)
    @assertEq(entryValue(env, 0), "")
}
